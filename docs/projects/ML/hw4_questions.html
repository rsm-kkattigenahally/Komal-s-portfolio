<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Komal Kattigenahally">
<meta name="dcterms.date" content="2025-06-11">

<title>Latent class MNL and KNN – Komal’s Portfolio</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>



<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Komal’s Portfolio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume.html"> 
<span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#latent-class-mnl" id="toc-latent-class-mnl" class="nav-link active" data-scroll-target="#latent-class-mnl">Latent-Class MNL</a>
  <ul class="collapse">
  <li><a href="#utility-specification" id="toc-utility-specification" class="nav-link" data-scroll-target="#utility-specification">Utility Specification</a></li>
  <li><a href="#standard-mnl-on-yogurt-data" id="toc-standard-mnl-on-yogurt-data" class="nav-link" data-scroll-target="#standard-mnl-on-yogurt-data">Standard MNL on Yogurt data</a></li>
  <li><a href="#latent-class-mnl-model-on-yogurt-dataset" id="toc-latent-class-mnl-model-on-yogurt-dataset" class="nav-link" data-scroll-target="#latent-class-mnl-model-on-yogurt-dataset">Latent class MNL model on Yogurt dataset</a></li>
  </ul></li>
  <li><a href="#k-nearest-neighbors" id="toc-k-nearest-neighbors" class="nav-link" data-scroll-target="#k-nearest-neighbors">K Nearest Neighbors</a>
  <ul class="collapse">
  <li><a href="#how-knn-works" id="toc-how-knn-works" class="nav-link" data-scroll-target="#how-knn-works">How KNN Works</a></li>
  <li><a href="#euclidean-distance" id="toc-euclidean-distance" class="nav-link" data-scroll-target="#euclidean-distance">Euclidean Distance</a></li>
  <li><a href="#classification-rule" id="toc-classification-rule" class="nav-link" data-scroll-target="#classification-rule">Classification Rule</a></li>
  <li><a href="#choosing-the-right-k" id="toc-choosing-the-right-k" class="nav-link" data-scroll-target="#choosing-the-right-k">Choosing the Right k</a></li>
  <li><a href="#generate-synthetic-data" id="toc-generate-synthetic-data" class="nav-link" data-scroll-target="#generate-synthetic-data">Generate Synthetic Data</a></li>
  <li><a href="#knn-implementation-by-hand-vs-kneighborsclassifier" id="toc-knn-implementation-by-hand-vs-kneighborsclassifier" class="nav-link" data-scroll-target="#knn-implementation-by-hand-vs-kneighborsclassifier">KNN implementation by hand Vs KNeighborsClassifier</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Latent class MNL and KNN</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Komal Kattigenahally </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 11, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="latent-class-mnl" class="level2">
<h2 class="anchored" data-anchor-id="latent-class-mnl">Latent-Class MNL</h2>
<p>In this project, we will create a latent class MNL for a Yogurt purchase data. The Latent Class Multinomial Logit (LC-MNL) model is an extension of the standard Multinomial Logit (MNL) model that captures unobserved heterogeneity in individual decision-making. While the MNL model assumes all individuals share the same preferences, the LC-MNL model allows for the population to consist of several latent (hidden) segments or classes, each with distinct choice behaviors.</p>
<section id="utility-specification" class="level3">
<h3 class="anchored" data-anchor-id="utility-specification">Utility Specification</h3>
<p>Let the utility that individual <span class="math inline">\(n\)</span> obtains from choosing alternative <span class="math inline">\(j\)</span> in class <span class="math inline">\(s\)</span> be:</p>
<p><span class="math display">\[
U_{nj}^{(s)} = X_{nj}'\beta_s + \varepsilon_{nj}
\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(X_{nj}\)</span> is the vector of observed attributes of the alternative<br>
</li>
<li><span class="math inline">\(\beta_s\)</span> is the class-specific coefficient vector<br>
</li>
<li><span class="math inline">\(\varepsilon_{nj}\)</span> is a random error term</li>
</ul>
<p>The probability that an individual belongs to class <span class="math inline">\(s\)</span> is denoted <span class="math inline">\(\pi_s\)</span>, such that:</p>
<p><span class="math display">\[
\sum_{s=1}^{S} \pi_s = 1
\]</span></p>
<p>The choice probability for individual <span class="math inline">\(n\)</span> choosing alternative <span class="math inline">\(j\)</span>, marginalizing over classes, is:</p>
<p><span class="math display">\[
P_{nj} = \sum_{s=1}^{S} \pi_s \cdot \frac{\exp(X_{nj}'\beta_s)}{\sum_{k=1}^{J} \exp(X_{nk}'\beta_s)}
\]</span></p>
<p>In the standard Multinomial Logit (MNL) model, Alternative-Specific Constants (ASCs) are included to account for the inherent preference for each product that is not explained by observable attributes such as price or featured status. These constants capture baseline utility differences between alternatives.</p>
<p>Mathematically, the utility of individual <span class="math inline">\(n\)</span> choosing alternative <span class="math inline">\(j\)</span> can be written as:</p>
<p><span class="math display">\[
U_{nj} = ASC_j + \beta_1 \cdot \text{price}_{nj} + \beta_2 \cdot \text{featured}_{nj} + \varepsilon_{nj}
\]</span></p>
<p>Where <span class="math inline">\(ASC_j\)</span> is the alternative-specific constant for product <span class="math inline">\(j\)</span>. One of the ASCs (typically for the base category) is omitted to avoid perfect multicollinearity. The remaining ASCs indicate how much more or less preferred each alternative is compared to the base product, holding all else equal.</p>
<section id="yogurt-latent-class-mnl" class="level4">
<h4 class="anchored" data-anchor-id="yogurt-latent-class-mnl">Yogurt latent class MNL</h4>
<p>In the Yogurt dataset that we have, anonymized consumer identifiers (<code>id</code>), a vector indicating the chosen product (<code>y1</code>:<code>y4</code>), a vector indicating if any products were “featured” in the store as a form of advertising (<code>f1</code>:<code>f4</code>), and the products’ prices in price-per-ounce (<code>p1</code>:<code>p4</code>). For example, consumer 1 purchased yogurt 4 at a price of 0.079/oz and none of the yogurts were featured/advertised at the time of consumer 1’s purchase.</p>
<p>Data preview -</p>
<div id="6d570bd3" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>yogurt_data <span class="op">=</span> pd.read_csv(<span class="st">'yogurt_data.csv'</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>yogurt_data.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">y1</th>
<th data-quarto-table-cell-role="th">y2</th>
<th data-quarto-table-cell-role="th">y3</th>
<th data-quarto-table-cell-role="th">y4</th>
<th data-quarto-table-cell-role="th">f1</th>
<th data-quarto-table-cell-role="th">f2</th>
<th data-quarto-table-cell-role="th">f3</th>
<th data-quarto-table-cell-role="th">f4</th>
<th data-quarto-table-cell-role="th">p1</th>
<th data-quarto-table-cell-role="th">p2</th>
<th data-quarto-table-cell-role="th">p3</th>
<th data-quarto-table-cell-role="th">p4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
<td>0.081</td>
<td>0.061</td>
<td>0.079</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
<td>0.098</td>
<td>0.064</td>
<td>0.075</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
<td>0.098</td>
<td>0.061</td>
<td>0.086</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
<td>0.098</td>
<td>0.061</td>
<td>0.086</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.125</td>
<td>0.098</td>
<td>0.049</td>
<td>0.079</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>6</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
<td>0.092</td>
<td>0.050</td>
<td>0.079</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>7</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.103</td>
<td>0.081</td>
<td>0.049</td>
<td>0.079</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>8</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
<td>0.086</td>
<td>0.054</td>
<td>0.079</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>9</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
<td>0.098</td>
<td>0.050</td>
<td>0.079</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>10</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
<td>0.098</td>
<td>0.050</td>
<td>0.079</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We will first reshape this dataset from wide to long format</p>
<div id="1e6d533f" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Reshape dataset </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>yogurt_data <span class="op">=</span> pd.wide_to_long(yogurt_data,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                          stubnames<span class="op">=</span>[<span class="st">'y'</span>, <span class="st">'f'</span>, <span class="st">'p'</span>],</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                          i<span class="op">=</span><span class="st">'id'</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                          j<span class="op">=</span><span class="st">'product'</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                          sep<span class="op">=</span><span class="st">''</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                          suffix<span class="op">=</span><span class="st">'[1-4]'</span>).reset_index()</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename columns for clarity</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>yogurt_data <span class="op">=</span> yogurt_data.rename(columns<span class="op">=</span>{</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'y'</span>: <span class="st">'chosen'</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'f'</span>: <span class="st">'featured'</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'p'</span>: <span class="st">'price'</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>yogurt_data.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">product</th>
<th data-quarto-table-cell-role="th">chosen</th>
<th data-quarto-table-cell-role="th">featured</th>
<th data-quarto-table-cell-role="th">price</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.125</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>6</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>7</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.103</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>8</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.108</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>9</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0.108</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>10</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0.108</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In the above reshaped data, each row represents a consumer–product combination with with data about if the product was chosen by the consumer, if the product was featured abd the price per ounce for that product.</p>
</section>
</section>
<section id="standard-mnl-on-yogurt-data" class="level3">
<h3 class="anchored" data-anchor-id="standard-mnl-on-yogurt-data">Standard MNL on Yogurt data</h3>
<p>Here we will fit a standard MNL model on the reshaped dataset. When fitting the MNL model in Python using libraries like statsmodels, the ASCs are not automatically created from a categorical variable like product. Therefore, we manually create dummy variables for alternatives using one-hot encoding. The process are as follows -</p>
<ol type="1">
<li>One-hot encode the product variable: This converts the product IDs into binary variables. We drop one column (e.g., for product 1) to act as the reference category.</li>
</ol>
<p>These dummy variables become our ASCs. They allow the model to capture each product’s inherent preference or appeal that isn’t explained by price or promotion. Without ASCs, the model would wrongly assume all products are equally preferred when price and promotion are the same.</p>
<ol start="2" type="1">
<li>Merge dummies into the dataset: After encoding, we merge these dummy columns with the dataset so that they can be used as predictors in the model.</li>
</ol>
<p>Below we see the code to carry out the above steps.</p>
<div id="f27470a7" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>encoder <span class="op">=</span> OneHotEncoder(drop<span class="op">=</span><span class="st">'first'</span>, sparse_output<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>product_dummies <span class="op">=</span> encoder.fit_transform(yogurt_data[[<span class="st">'product'</span>]])</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame with appropriate column names</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>product_dummies_df <span class="op">=</span> pd.DataFrame(product_dummies, columns<span class="op">=</span>encoder.get_feature_names_out())</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge dummies with main data</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>yogurt_data <span class="op">=</span> pd.concat([yogurt_data.reset_index(drop<span class="op">=</span><span class="va">True</span>), product_dummies_df.reset_index(drop<span class="op">=</span><span class="va">True</span>)], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>product_dummies_df</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Define independent variables (price, featured, and ASCs)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> yogurt_data[[<span class="st">'price'</span>, <span class="st">'featured'</span>] <span class="op">+</span> <span class="bu">list</span>(product_dummies_df.columns)]</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> sm.add_constant(X)  <span class="co"># Add intercept</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>X</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">const</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">featured</th>
<th data-quarto-table-cell-role="th">product_2</th>
<th data-quarto-table-cell-role="th">product_3</th>
<th data-quarto-table-cell-role="th">product_4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1.0</td>
<td>0.108</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1.0</td>
<td>0.108</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1.0</td>
<td>0.108</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1.0</td>
<td>0.108</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1.0</td>
<td>0.125</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9715</td>
<td>1.0</td>
<td>0.086</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9716</td>
<td>1.0</td>
<td>0.086</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9717</td>
<td>1.0</td>
<td>0.086</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9718</td>
<td>1.0</td>
<td>0.086</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9719</td>
<td>1.0</td>
<td>0.079</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>

<p>9720 rows × 6 columns</p>
</div>
</div>
</div>
<p>The independent variables for the model includes:</p>
<ul>
<li><p>price: price per ounce</p></li>
<li><p>featured: whether the product was promoted</p></li>
<li><p>product_2, product_3, product_4: dummy variables representing ASCs for products 2, 3, and 4 (product 1 is the reference)</p></li>
</ul>
<div id="59da231f" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dependent variable: whether the product was chosen (1 if chosen, 0 otherwise)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> yogurt_data[<span class="st">'chosen'</span>]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>0       0
1       0
2       0
3       0
4       0
       ..
9715    1
9716    1
9717    1
9718    1
9719    1
Name: chosen, Length: 9720, dtype: int64</code></pre>
</div>
</div>
<p>The above data is our dependent variable.</p>
<div id="d1ca7461" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the Multinomial Logit model</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.MNLogit(y, X)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> model.fit()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Show model summary</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>result.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization terminated successfully.
         Current function value: 0.477971
         Iterations 7</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<table class="simpletable caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>MNLogit Regression Results</caption>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Dep. Variable:</td>
<td>chosen</td>
<td data-quarto-table-cell-role="th">No. Observations:</td>
<td>9720</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Model:</td>
<td>MNLogit</td>
<td data-quarto-table-cell-role="th">Df Residuals:</td>
<td>9714</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Method:</td>
<td>MLE</td>
<td data-quarto-table-cell-role="th">Df Model:</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Date:</td>
<td>Wed, 11 Jun 2025</td>
<td data-quarto-table-cell-role="th">Pseudo R-squ.:</td>
<td>0.1500</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Time:</td>
<td>23:30:49</td>
<td data-quarto-table-cell-role="th">Log-Likelihood:</td>
<td>-4645.9</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">converged:</td>
<td>True</td>
<td data-quarto-table-cell-role="th">LL-Null:</td>
<td>-5465.9</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Covariance Type:</td>
<td>nonrobust</td>
<td data-quarto-table-cell-role="th">LLR p-value:</td>
<td>0.000</td>
</tr>
</tbody>
</table>


<table class="simpletable caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">chosen=1</td>
<td data-quarto-table-cell-role="th">coef</td>
<td data-quarto-table-cell-role="th">std err</td>
<td data-quarto-table-cell-role="th">z</td>
<td data-quarto-table-cell-role="th">P&gt;|z|</td>
<td data-quarto-table-cell-role="th">[0.025</td>
<td data-quarto-table-cell-role="th">0.975]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">const</td>
<td>2.7009</td>
<td>0.229</td>
<td>11.795</td>
<td>0.000</td>
<td>2.252</td>
<td>3.150</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">price</td>
<td>-31.9761</td>
<td>2.089</td>
<td>-15.305</td>
<td>0.000</td>
<td>-36.071</td>
<td>-27.881</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">featured</td>
<td>0.4714</td>
<td>0.119</td>
<td>3.959</td>
<td>0.000</td>
<td>0.238</td>
<td>0.705</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">product_2</td>
<td>-0.5166</td>
<td>0.081</td>
<td>-6.354</td>
<td>0.000</td>
<td>-0.676</td>
<td>-0.357</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">product_3</td>
<td>-4.5584</td>
<td>0.173</td>
<td>-26.319</td>
<td>0.000</td>
<td>-4.898</td>
<td>-4.219</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">product_4</td>
<td>-1.4179</td>
<td>0.089</td>
<td>-16.008</td>
<td>0.000</td>
<td>-1.591</td>
<td>-1.244</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>From the above summary we see, that</p>
<ul>
<li><p>Price has a very strong negative effect on the choice. Even a small increase in price substantially reduced the choice probability.</p></li>
<li><p>Featured promotions positively impact the consumer decision. This effect is small.</p></li>
<li><p>Product 1 is the most preferred product and Product 2 is least preferred.</p></li>
</ul>
</section>
<section id="latent-class-mnl-model-on-yogurt-dataset" class="level3">
<h3 class="anchored" data-anchor-id="latent-class-mnl-model-on-yogurt-dataset">Latent class MNL model on Yogurt dataset</h3>
<p>Next, we will fit a Latent-class MNL on the same data.</p>
<div id="34bd36e4" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> biogeme.database <span class="im">as</span> db</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> biogeme.biogeme <span class="im">as</span> bio</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> biogeme.expressions <span class="im">import</span> Beta, log, exp</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> biogeme <span class="im">import</span> models</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lc_mnl(K, df):</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    database <span class="op">=</span> db.Database(<span class="st">"yogurt"</span>, df)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    database.variables[<span class="st">'Choice'</span>] <span class="op">=</span> df[<span class="st">'chosen'</span>]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    av <span class="op">=</span> {<span class="dv">1</span>: <span class="dv">1</span>, <span class="dv">2</span>: <span class="dv">1</span>, <span class="dv">3</span>: <span class="dv">1</span>, <span class="dv">4</span>: <span class="dv">1</span>}</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    class_utilities <span class="op">=</span> []</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    membership_betas <span class="op">=</span> []</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, K <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        ASC2 <span class="op">=</span> Beta(<span class="ss">f'ASC2_class</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">'</span>, <span class="dv">0</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="dv">0</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        ASC3 <span class="op">=</span> Beta(<span class="ss">f'ASC3_class</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">'</span>, <span class="dv">0</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="dv">0</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        ASC4 <span class="op">=</span> Beta(<span class="ss">f'ASC4_class</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">'</span>, <span class="dv">0</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="dv">0</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        B_PRICE <span class="op">=</span> Beta(<span class="ss">f'B_PRICE_class</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">'</span>, <span class="dv">0</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="dv">0</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        B_FEAT <span class="op">=</span> Beta(<span class="ss">f'B_FEAT_class</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">'</span>, <span class="dv">0</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="dv">0</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        V <span class="op">=</span> {</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span>: <span class="dv">0</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span>: ASC2 <span class="op">+</span> B_PRICE <span class="op">*</span> database.variables[<span class="st">'price'</span>] <span class="op">+</span> B_FEAT <span class="op">*</span> database.variables[<span class="st">'featured'</span>],</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>            <span class="dv">3</span>: ASC3 <span class="op">+</span> B_PRICE <span class="op">*</span> database.variables[<span class="st">'price'</span>] <span class="op">+</span> B_FEAT <span class="op">*</span> database.variables[<span class="st">'featured'</span>],</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            <span class="dv">4</span>: ASC4 <span class="op">+</span> B_PRICE <span class="op">*</span> database.variables[<span class="st">'price'</span>] <span class="op">+</span> B_FEAT <span class="op">*</span> database.variables[<span class="st">'featured'</span>]</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        logprob <span class="op">=</span> models.loglogit(V, av, database.variables[<span class="st">'product'</span>])</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        class_utilities.append(logprob)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="op">&lt;</span> K:</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>            pi_k <span class="op">=</span> Beta(<span class="ss">f'PI_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">'</span>, <span class="fl">1.0</span> <span class="op">/</span> K, <span class="fl">0.0001</span>, <span class="fl">0.9999</span>, <span class="dv">0</span>)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            membership_betas.append(pi_k)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> K <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        PI <span class="op">=</span> [membership_betas[<span class="dv">0</span>], <span class="dv">1</span> <span class="op">-</span> membership_betas[<span class="dv">0</span>]]</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        exp_terms <span class="op">=</span> [exp(beta) <span class="cf">for</span> beta <span class="kw">in</span> membership_betas]</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        denominator <span class="op">=</span> <span class="bu">sum</span>(exp_terms) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        PI <span class="op">=</span> [term <span class="op">/</span> denominator <span class="cf">for</span> term <span class="kw">in</span> exp_terms]</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        PI.append(<span class="dv">1</span> <span class="op">-</span> <span class="bu">sum</span>(PI))</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    loglikelihood <span class="op">=</span> log(<span class="bu">sum</span>([PI[k] <span class="op">*</span> exp(class_utilities[k]) <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(K)]))</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    biogeme_model <span class="op">=</span> bio.BIOGEME(database, loglikelihood)</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    biogeme_model.modelName <span class="op">=</span> <span class="ss">f"LC_MNL_</span><span class="sc">{</span>K<span class="sc">}</span><span class="ss">classes"</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> biogeme_model.estimate()</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"K"</span>: K,</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"LogLikelihood"</span>: results.data.logLike,</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NumParams"</span>: results.data.nparam,</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"BIC"</span>: <span class="op">-</span><span class="dv">2</span> <span class="op">*</span> results.data.logLike <span class="op">+</span> results.data.nparam <span class="op">*</span> np.log(df[<span class="st">'id'</span>].nunique()),</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Parameters"</span>: results.get_estimated_parameters()</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To determine the optimal number of latent classes, we estimate LC-MNL models for 2, 3, 4, and 5 classes and compare them using the Bayesian Information Criterion (BIC) given by :</p>
<p><span class="math inline">\(BIC = -2*\ell_n  + k*log(n)\)</span>?</p>
<p>(where <span class="math inline">\(\ell_n\)</span> is the log-likelihood, <span class="math inline">\(n\)</span> is the sample size, and <span class="math inline">\(k\)</span> is the number of parameters.)</p>
<p>BIC is a widely used tool for comparing models in terms of both their fit and parsimony. Unlike the raw log-likelihood, which only measures how well a model explains the data, the BIC includes a penalty for model complexity—specifically, the number of estimated parameters. This ensures that adding more classes (which almost always improves fit) is only favored if the improvement is substantial enough to justify the added complexity.</p>
<p>In the context of the LC-MNL model, BIC allows us to determine the optimal number of latent classes. Each additional class introduces its own set of parameters (utility coefficients and class probabilities), which can risk overfitting if not justified by significant gains in likelihood.</p>
<div id="0313b96c" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>results_list <span class="op">=</span> []</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> K <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">6</span>):</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Estimating model for </span><span class="sc">{</span>K<span class="sc">}</span><span class="ss"> classes..."</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> lc_mnl(K, yogurt_data)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    results_list.append(res)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(f"Estimated parameters for K = {K}:")</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(res["Parameters"])</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>bic_df <span class="op">=</span> pd.DataFrame(results_list).sort_values(by<span class="op">=</span><span class="st">'BIC'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Estimating model for 2 classes...
Estimating model for 3 classes...
Estimating model for 4 classes...
Estimating model for 5 classes...</code></pre>
</div>
</div>
<div id="79faadae" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>bic_df[[<span class="st">'K'</span>, <span class="st">'LogLikelihood'</span>, <span class="st">'NumParams'</span>, <span class="st">'BIC'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">K</th>
<th data-quarto-table-cell-role="th">LogLikelihood</th>
<th data-quarto-table-cell-role="th">NumParams</th>
<th data-quarto-table-cell-role="th">BIC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>3</td>
<td>-8987.653693</td>
<td>17</td>
<td>18107.833378</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>5</td>
<td>-9270.488187</td>
<td>29</td>
<td>18767.050124</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>4</td>
<td>-9533.099772</td>
<td>23</td>
<td>19245.499414</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>2</td>
<td>-10505.854498</td>
<td>11</td>
<td>21097.461107</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The model with the lowest BIC is selected as the best-fitting model when balancing accuracy and simplicity. In our results, the 3-class model had the lowest BIC, suggesting that it best explains the data while avoiding unnecessary complexity.</p>
<section id="comparison-of-aggregate-mnl-vs.-latent-class-mnl-k-3" class="level4">
<h4 class="anchored" data-anchor-id="comparison-of-aggregate-mnl-vs.-latent-class-mnl-k-3">Comparison of Aggregate MNL vs.&nbsp;Latent-Class MNL (K = 3)</h4>
<p>Now we compare the parameter estimates between (1) the aggregate MNL, and (2) the latent-class MNL with the number of classes suggested by the BIC.</p>
<div id="d6a9809c" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>lc_mnl_3class_params <span class="op">=</span> results_list[[res[<span class="st">"K"</span>] <span class="cf">for</span> res <span class="kw">in</span> results_list].index(<span class="dv">3</span>)][<span class="st">"Parameters"</span>].reset_index()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>lc_mnl_3class_params.columns</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>class3_params <span class="op">=</span> lc_mnl_3class_params.loc[lc_mnl_3class_params[<span class="st">'index'</span>].<span class="bu">str</span>.contains(<span class="st">'_class3'</span>)]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Class 3 parameter estimates"</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(class3_params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Class 3 parameter estimates
             index        Value  Active bound  Rob. Std err  Rob. t-test  \
2      ASC2_class3  -605.010055           0.0     33.700522   -17.952543   
5      ASC3_class3  -609.283694           0.0     33.717245   -18.070388   
8      ASC4_class3  -604.219992           0.0     33.709284   -17.924438   
11   B_FEAT_class3  -613.933324           0.0     33.234146   -18.472968   
14  B_PRICE_class3  9678.824025           0.0    535.352517    18.079347   

    Rob. p-value  
2            0.0  
5            0.0  
8            0.0  
11           0.0  
14           0.0  </code></pre>
</div>
</div>
</section>
<section id="price-sensitivity" class="level4">
<h4 class="anchored" data-anchor-id="price-sensitivity">1. Price Sensitivity</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 16%">
<col style="width: 24%">
<col style="width: 59%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Price Coefficient</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Aggregate MNL</td>
<td>–31.98 (significant)</td>
<td>Consumers are price-sensitive overall.</td>
</tr>
<tr class="even">
<td>LC-MNL Class 1</td>
<td>–3317.95 (not significant)</td>
<td>Very large, likely unstable estimate.</td>
</tr>
<tr class="odd">
<td>LC-MNL Class 2</td>
<td>–2799.99 (<strong>significant</strong>)</td>
<td>Very strong price aversion.</td>
</tr>
<tr class="even">
<td>LC-MNL Class 3</td>
<td>+9678.82 (<strong>significant</strong>)</td>
<td>Counterintuitive: price increases utility (possible overfitting or perceived quality).</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="featured-promotion" class="level4">
<h4 class="anchored" data-anchor-id="featured-promotion">2. Featured Promotion</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 16%">
<col style="width: 25%">
<col style="width: 58%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Featured Coefficient</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Aggregate MNL</td>
<td>+0.471 (significant)</td>
<td>Promotion increases likelihood of choice.</td>
</tr>
<tr class="even">
<td>LC-MNL Class 1</td>
<td>+13.75 (significant)</td>
<td>Strong positive impact of being featured.</td>
</tr>
<tr class="odd">
<td>LC-MNL Class 2</td>
<td>+19.73 (significant)</td>
<td>Even stronger promotional effect.</td>
</tr>
<tr class="even">
<td>LC-MNL Class 3</td>
<td>–613.93 (significant)</td>
<td>Strong negative effect — promotions deter choice.</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="alternative-specific-constants-ascs" class="level4">
<h4 class="anchored" data-anchor-id="alternative-specific-constants-ascs">3. Alternative-Specific Constants (ASCs)</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Product</th>
<th>Aggregate MNL</th>
<th>LC Class 1</th>
<th>LC Class 2</th>
<th>LC Class 3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ASC2</td>
<td>–0.5166</td>
<td>–1.02</td>
<td>+280.04</td>
<td>–605.01</td>
</tr>
<tr class="even">
<td>ASC3</td>
<td>–4.5584</td>
<td>+222.88</td>
<td>+0.86</td>
<td>–609.28</td>
</tr>
<tr class="odd">
<td>ASC4</td>
<td>–1.4179</td>
<td>–2.92</td>
<td>+279.78</td>
<td>–604.22</td>
</tr>
</tbody>
</table>
<p>Interpretation: - LC-MNL reveals stark contrasts between classes. - Class 2 prefers all products highly. - Class 3 strongly disfavors all alternatives — unusual, possibly unstable.</p>
<hr>
</section>
<section id="class-membership-probabilities" class="level4">
<h4 class="anchored" data-anchor-id="class-membership-probabilities">4. Class Membership Probabilities</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 13%">
<col style="width: 15%">
<col style="width: 71%">
</colgroup>
<thead>
<tr class="header">
<th>Class</th>
<th>Share (PI)</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Class 1</td>
<td>0.730</td>
<td>Majority: strong effects for price and promotion.</td>
</tr>
<tr class="even">
<td>Class 2</td>
<td>0.999</td>
<td>Possibly absorbing similar behavior as Class 1.</td>
</tr>
<tr class="odd">
<td>Class 3</td>
<td>~0</td>
<td>Tiny segment with extreme (and conflicting) effects.</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="conclusion" class="level4">
<h4 class="anchored" data-anchor-id="conclusion"><strong>Conclusion</strong></h4>
<p>The aggregate MNL provides a stable average picture of consumer behavior: moderate price sensitivity and positive reaction to promotions.</p>
<p>However, the 3-class LC-MNL uncovers <strong>rich heterogeneity</strong>: - <strong>Class 1</strong> behaves similarly to the aggregate trend. - <strong>Class 2</strong> intensifies the promotional impact. - <strong>Class 3</strong> behaves unusually, disliking promotions and favoring higher prices — likely capturing edge cases or requiring more robust modeling.</p>
<p>Latent class modeling yields <strong>deeper behavioral insights</strong> that would be hidden in an aggregate approach — but demands careful interpretation, especially for small or extreme segments.</p>
</section>
</section>
</section>
<section id="k-nearest-neighbors" class="level2">
<h2 class="anchored" data-anchor-id="k-nearest-neighbors">K Nearest Neighbors</h2>
<section id="how-knn-works" class="level3">
<h3 class="anchored" data-anchor-id="how-knn-works">How KNN Works</h3>
<p>Given a data point <span class="math inline">\(x_{\text{test}}\)</span> to classify:</p>
<ol type="1">
<li>Compute the <strong>distance</strong> between <span class="math inline">\(x_{\text{test}}\)</span> and all training points <span class="math inline">\(x_i\)</span>.</li>
<li>Identify the <span class="math inline">\(k\)</span> closest training points (called the <strong>k-nearest neighbors</strong>).</li>
<li>Assign the <strong>majority class</strong> label among those <span class="math inline">\(k\)</span> neighbors to <span class="math inline">\(x_{\text{test}}\)</span>.</li>
</ol>
<hr>
</section>
<section id="euclidean-distance" class="level3">
<h3 class="anchored" data-anchor-id="euclidean-distance">Euclidean Distance</h3>
<p>The most commonly used distance metric is the <strong>Euclidean distance</strong>, defined for two points <span class="math inline">\(x = (x_1, x_2, \dots, x_d)\)</span> and <span class="math inline">\(z = (z_1, z_2, \dots, z_d)\)</span> as:</p>
<p><span class="math display">\[
d(x, z) = \sqrt{(x_1 - z_1)^2 + (x_2 - z_2)^2 + \cdots + (x_d - z_d)^2}
\]</span></p>
<p>For our 2D case with features <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>:</p>
<p><span class="math display">\[
d((x_1, x_2), (z_1, z_2)) = \sqrt{(x_1 - z_1)^2 + (x_2 - z_2)^2}
\]</span></p>
<hr>
</section>
<section id="classification-rule" class="level3">
<h3 class="anchored" data-anchor-id="classification-rule">Classification Rule</h3>
<p>Let <span class="math inline">\(\mathcal{N}_k(x)\)</span> denote the set of indices of the <span class="math inline">\(k\)</span> nearest neighbors of point <span class="math inline">\(x\)</span>.<br>
Then the predicted class <span class="math inline">\(\hat{y}\)</span> is:</p>
<p><span class="math display">\[
\hat{y} = \arg\max_{c \in \{0,1\}} \sum_{i \in \mathcal{N}_k(x)} \mathbb{1}(y_i = c)
\]</span></p>
<p>Where: - <span class="math inline">\(\mathbb{1}(y_i = c)\)</span> is an indicator function (1 if true, 0 if false), - This counts how many of the <span class="math inline">\(k\)</span> neighbors belong to class <span class="math inline">\(c\)</span>, - The class with the highest count becomes the predicted class.</p>
<hr>
</section>
<section id="choosing-the-right-k" class="level3">
<h3 class="anchored" data-anchor-id="choosing-the-right-k">Choosing the Right k</h3>
<ul>
<li>Small <span class="math inline">\(k\)</span> values (like <span class="math inline">\(k=1\)</span>) can be sensitive to noise and may overfit.</li>
<li>Larger <span class="math inline">\(k\)</span> values smooth out the decision boundary but may underfit.</li>
<li>The optimal <span class="math inline">\(k\)</span> is usually chosen using validation data or cross-validation.</li>
</ul>
<hr>
<p>In this section, we will explore how the K Nearest Neighbors (KNN) algorithm works using a synthetic dataset. We will implement KNN from scratch, compare it with a built-in classifier, and analyze how the value of k impacts model accuracy.</p>
</section>
<section id="generate-synthetic-data" class="level3">
<h3 class="anchored" data-anchor-id="generate-synthetic-data">Generate Synthetic Data</h3>
<p>The following code will generate a synthetic dataset for the k-nearest neighbors algorithm. The code generates a dataset with two features, <code>x1</code> and <code>x2</code>, and a binary outcome variable <code>y</code> that is determined by whether <code>x2</code> is above or below a wiggly boundary defined by a sin function</p>
<div id="0bffde48" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate data</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>x1 <span class="op">=</span> np.random.uniform(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>, n)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>x2 <span class="op">=</span> np.random.uniform(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>, n)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>boundary <span class="op">=</span> np.sin(<span class="dv">4</span> <span class="op">*</span> x1) <span class="op">+</span> x1</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> (x2 <span class="op">&gt;</span> boundary).astype(<span class="bu">int</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({<span class="st">'x1'</span>: x1, <span class="st">'x2'</span>: x2, <span class="st">'y'</span>: y})</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-0.752759</td>
<td>-2.811425</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2.704286</td>
<td>0.818462</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1.391964</td>
<td>-1.113864</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.591951</td>
<td>0.051424</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-2.063888</td>
<td>2.445399</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>-0.037226</td>
<td>-0.904743</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>0.136397</td>
<td>1.355734</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>-0.434754</td>
<td>2.382662</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>-2.847485</td>
<td>2.322519</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99</td>
<td>-2.352651</td>
<td>1.679253</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>100 rows × 3 columns</p>
</div>
</div>
</div>
<p>We can visualize the dataset in 2D, using color to represent the binary class (y). We also overlay the wiggly boundary that separates the two classes.</p>
<div id="83d18698" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">6</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(df[<span class="st">'x1'</span>], df[<span class="st">'x2'</span>], c<span class="op">=</span>df[<span class="st">'y'</span>], cmap<span class="op">=</span><span class="st">'bwr'</span>, edgecolor<span class="op">=</span><span class="st">'k'</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>x_line <span class="op">=</span> np.linspace(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">500</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>boundary_line <span class="op">=</span> np.sin(<span class="dv">4</span> <span class="op">*</span> x_line) <span class="op">+</span> x_line</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>plt.plot(x_line, boundary_line, <span class="st">'k--'</span>, label<span class="op">=</span><span class="st">'Boundary'</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'x1'</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'x2'</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Synthetic Dataset'</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hw4_questions_files/figure-html/cell-12-output-1.png" width="662" height="523" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>To evaluate the generalization performance of our model, we create a new test dataset using a different random seed. This ensures the test data is independent of the training set.</p>
<div id="01a83e01" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">19</span>)  <span class="co"># different seed</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>x1_test <span class="op">=</span> np.random.uniform(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>, n)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>x2_test <span class="op">=</span> np.random.uniform(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>, n)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>boundary_test <span class="op">=</span> np.sin(<span class="dv">4</span> <span class="op">*</span> x1_test) <span class="op">+</span> x1_test</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> (x2_test <span class="op">&gt;</span> boundary_test).astype(<span class="bu">int</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.DataFrame({<span class="st">'x1'</span>: x1_test, <span class="st">'x2'</span>: x2_test, <span class="st">'y'</span>: y_test})</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>test_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-2.414798</td>
<td>1.925009</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1.567498</td>
<td>1.899944</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-1.518372</td>
<td>-1.001426</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-2.171210</td>
<td>1.053791</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-1.011321</td>
<td>2.900615</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>-1.764803</td>
<td>-2.503910</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>-1.274871</td>
<td>-1.705154</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>-0.711182</td>
<td>1.546217</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>2.011124</td>
<td>-1.815811</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99</td>
<td>-2.507545</td>
<td>-0.332287</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>100 rows × 3 columns</p>
</div>
</div>
</div>
</section>
<section id="knn-implementation-by-hand-vs-kneighborsclassifier" class="level3">
<h3 class="anchored" data-anchor-id="knn-implementation-by-hand-vs-kneighborsclassifier">KNN implementation by hand Vs KNeighborsClassifier</h3>
<p>Here we define a custom KNN classifier using the Euclidean distance between test and training points. For each test instance, the k closest neighbors are selected, and the predicted class is determined by majority vote.</p>
<div id="2c943936" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.spatial <span class="im">import</span> distance</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> KNeighborsClassifier</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> knn_predict(X_train, y_train, X_test, k):</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> []</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> test_point <span class="kw">in</span> X_test:</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        dists <span class="op">=</span> [distance.euclidean(test_point, train_point) <span class="cf">for</span> train_point <span class="kw">in</span> X_train]</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        knn_indices <span class="op">=</span> np.argsort(dists)[:k]</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        knn_labels <span class="op">=</span> y_train[knn_indices]</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use np.bincount safely: labels must be integers starting from 0</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If labels are 0 and 1, this is fine</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        majority_vote <span class="op">=</span> np.argmax(np.bincount(knn_labels))</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        y_pred.append(majority_vote)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(y_pred)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare train and test datasets</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> df[[<span class="st">'x1'</span>, <span class="st">'x2'</span>]].values</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> df[<span class="st">'y'</span>].values.astype(<span class="bu">int</span>)  <span class="co"># convert to int</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> test_df[[<span class="st">'x1'</span>, <span class="st">'x2'</span>]].values</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> test_df[<span class="st">'y'</span>].values.astype(<span class="bu">int</span>)  <span class="co"># convert to int</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert y arrays to numpy integer arrays if needed</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> np.array(y_train).astype(<span class="bu">int</span>)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> np.array(y_test).astype(<span class="bu">int</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Built-in KNN classifier</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>clf <span class="op">=</span> KNeighborsClassifier(n_neighbors<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>clf.fit(X_train, y_train)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>y_lib_pred <span class="op">=</span> clf.predict(X_test)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Your manual KNN prediction</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>y_hand_pred <span class="op">=</span> knn_predict(X_train, y_train, X_test, k<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare predictions</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Hand-coded KNN accuracy:"</span>, accuracy_score(y_test, y_hand_pred))</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Library KNN accuracy:   "</span>, accuracy_score(y_test, y_lib_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hand-coded KNN accuracy: 0.87
Library KNN accuracy:    0.87</code></pre>
</div>
</div>
<p>Now we run our custom KNN function across a range of k values (from 1 to 30) to observe how accuracy varies. This helps us identify the optimal value of k that balances underfitting and overfitting.</p>
<div id="0bb18963" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> df[[<span class="st">'x1'</span>, <span class="st">'x2'</span>]].values</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> df[<span class="st">'y'</span>].values</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> test_df[[<span class="st">'x1'</span>, <span class="st">'x2'</span>]].values</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> test_df[<span class="st">'y'</span>].values</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>accuracies <span class="op">=</span> []</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">31</span>):</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> knn_predict(X_train, y_train, X_test, k)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> accuracy_score(y_test, y_pred)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    accuracies.append(acc <span class="op">*</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We plot the accuracy of the KNN model as a function of k to visualize the trend and identify the best k value.</p>
<div id="f34cb229" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">5</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">31</span>), accuracies, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'k'</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Accuracy (%)'</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'KNN Accuracy on Test Data'</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>optimal_k <span class="op">=</span> np.argmax(accuracies) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Optimal k: </span><span class="sc">{</span>optimal_k<span class="sc">}</span><span class="ss"> with accuracy: </span><span class="sc">{</span>accuracies[optimal_k<span class="op">-</span><span class="dv">1</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hw4_questions_files/figure-html/cell-16-output-1.png" width="659" height="449" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal k: 1 with accuracy: 92.00%</code></pre>
</div>
</div>
<p><strong>Inference from the plot the accuracy of the KNN model as a function of k</strong></p>
<ul>
<li><p><strong>Highest Accuracy at ( k = 1 )</strong> : The model achieves its <strong>highest accuracy (~92%)</strong> when ( k = 1 ).</p></li>
<li><p><strong>Sharp Drop from ( k = 2 ) to ( k = 4 )</strong> : Accuracy declines quickly from ~90% to around 86–87% when ( k ) increases from 2 to 4.</p></li>
<li><p><strong>Fluctuations Between ( k = 5 ) and ( k = 15 )</strong> : Accuracy fluctuates without a clear upward or downward trend. This suggests that the model struggles to capture a consistently optimal decision boundary in this range.</p></li>
<li><p><strong>Plateau After ( k )</strong> : For values of ( k ), accuracy stabilizes around <strong>85–86%</strong>. This trend reflects <strong>underfitting</strong>, where the model becomes too smooth and loses its ability to separate complex patterns in the data.</p></li>
<li><p><strong>Optimal Trade-off</strong>: While ( k = 1 ) yields the best test performance, using a slightly higher ( k ) (e.g., ( k = 3 ) or ( k = 5 )) may provide a better <strong>bias-variance trade-off</strong>. This reduces the risk of overfitting while maintaining high accuracy.</p></li>
<li><p><strong>Summary :</strong></p></li>
<li><p><strong>Best test accuracy</strong>: ( k = 1 )</p></li>
<li><p><strong>Recommended practical range</strong>: ( k = 3 ) to ( k = 5 ) for more robust results.</p></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>